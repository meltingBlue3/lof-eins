---
phase: 02-pdf-processing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/data/pdf_extractor.py
  - tests/test_pdf_extractor.py
autonomous: true
must_haves:
  truths:
    - "Can extract text from Chinese PDF announcements"
    - "Handles multi-page PDFs with page markers"
    - "Gracefully handles extraction failures"
    - "Achieves 95%+ extraction success rate"
  artifacts:
    - path: "src/data/pdf_extractor.py"
      provides: "PDF text extraction with pdfplumber"
      exports: ["extract_pdf_text", "PDFExtractionError"]
    - path: "tests/test_pdf_extractor.py"
      provides: "Unit tests for PDF extraction"
      min_tests: 5
  key_links:
    - from: "extract_pdf_text()"
      to: "pdfplumber.open()"
      pattern: "pdfplumber\.open"
---

<objective>
Implement PDF text extraction module using pdfplumber for Chinese LOF fund announcements.

Purpose: Extract raw text content from downloaded PDF files to feed into LLM parsing pipeline.
Output: Working `src/data/pdf_extractor.py` with robust Chinese text handling and comprehensive tests.
</objective>

<execution_context>
@C:\Users\zhang\.config\opencode/get-shit-done/workflows/execute-plan.md
@C:\Users\zhang\.config\opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-pdf-processing/02-CONTEXT.md

## Phase 2 Context Summary

**Goal:** Extract text from downloaded PDF announcements using pdfplumber (better Chinese support than PyPDF2).

**Requirements:**
- PDF-01: Extract text from downloaded PDF announcements
- Handle Chinese text encoding correctly
- Clean and normalize extracted text

**Key Decisions from CONTEXT.md:**
- Use pdfplumber for superior Chinese text and table support
- Hybrid table handling: detect tables, preserve structure, fallback to plain text
- Page-aware extraction with page markers ("--- Page N ---")
- 95% extraction success threshold
- Log failures, continue processing, track for manual review

**Existing Data:**
- PDFs located at: `data/real_all_lof/announcements/{ticker}/{date}_{title}.pdf`
- Example: `160105/2024-12-06_南方基金管理股份有限公司关于旗下基金投资关联方承销证券的关联交易公告.pdf`

**Database Schema (from Phase 1):**
- `announcement_parses` table ready for storing parse results
- Columns: id, ticker, announcement_date, pdf_filename, parse_result (JSON), parse_type, confidence, processed, created_at
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PDF extraction module</name>
  <files>src/data/pdf_extractor.py</files>
  <action>
Create `src/data/pdf_extractor.py` with the following components:

1. **Imports**: pdfplumber, pathlib, logging, typing

2. **Custom Exception**:
   ```python
   class PDFExtractionError(Exception):
       """Raised when PDF extraction fails."""
       pass
   ```

3. **Main Function**: `extract_pdf_text(pdf_path: Path | str) -> dict`
   - Returns dict with keys: `success` (bool), `text` (str), `pages` (int), `error` (str | None)
   - Use pdfplumber to open PDF
   - Extract text from each page
   - Add page markers: "\n--- Page {n} ---\n" between pages
   - Handle Chinese text correctly (pdfplumber should handle UTF-8)
   - Clean whitespace: normalize multiple spaces/newlines
   - Return structured result

4. **Error Handling**:
   - Catch pdfplumber exceptions
   - Return `success=False` with error message instead of raising
   - Handle file not found, corrupted PDF, permission errors

5. **Helper Function**: `_clean_text(text: str) -> str`
   - Normalize whitespace (multiple spaces -> single)
   - Preserve Chinese punctuation
   - Remove excessive newlines but keep paragraph structure

6. **Logging**:
   - Log extraction attempts at INFO level
   - Log failures at WARNING level with file path

**Design Notes:**
- Keep it simple - no table extraction yet (add in enhancement if needed)
- Focus on robust text extraction first
- Document that pdfplumber handles Chinese better than alternatives
  </action>
  <verify>
python -c "from src.data.pdf_extractor import extract_pdf_text, PDFExtractionError; print('Import successful')"
  </verify>
  <done>
- Module imports without errors
- extract_pdf_text function exists with correct signature
- PDFExtractionError exception exists
  </done>
</task>

<task type="auto">
  <name>Task 2: Create unit tests</name>
  <files>tests/test_pdf_extractor.py</files>
  <action>
Create `tests/test_pdf_extractor.py` with comprehensive tests:

1. **Test Class**: `TestPDFExtractor(unittest.TestCase)`

2. **Test Cases**:
   - `test_extract_real_pdf`: Test with actual PDF from data/real_all_lof/announcements/
     - Use existing PDF file (find one that's available)
     - Verify text is extracted (non-empty)
     - Verify page count > 0
     - Verify success=True
   
   - `test_extract_nonexistent_file`: Test error handling
     - Pass fake path
     - Verify success=False
     - Verify error message is set
   
   - `test_extract_returns_dict_structure`: Verify return format
     - Check all required keys exist
     - Check types of each value
   
   - `test_page_markers_present`: Verify page markers in output
     - Check that "--- Page" appears in extracted text
   
   - `test_chinese_text_preserved`: Verify Chinese characters
     - Look for Chinese characters in output (if real PDF has them)

3. **Test Fixtures**:
   - Use `setUp` to find a real PDF path dynamically
   - Skip tests gracefully if no PDFs available

4. **Run Tests**:
   - Ensure all tests pass
  </action>
  <verify>
python -m pytest tests/test_pdf_extractor.py -v
  </verify>
  <done>
- At least 5 test cases defined
- All tests pass
- Tests cover success and failure paths
- Tests verify Chinese text handling
  </done>
</task>

<task type="auto">
  <name>Task 3: Add requirements and verify integration</name>
  <files>requirements.txt</files>
  <action>
1. **Update requirements.txt**:
   - Add `pdfplumber>=0.10.0` to requirements
   - Keep alphabetical order

2. **Verify Installation**:
   - Show command to install: `pip install pdfplumber`

3. **Create Simple CLI Test**:
   - Add `if __name__ == "__main__":` block to pdf_extractor.py
   - Accept PDF path as command line argument
   - Print extracted text or error
   - Example usage: `python src/data/pdf_extractor.py data/real_all_lof/announcements/160105/example.pdf`

4. **Integration Check**:
   - Verify module can be imported from project root
   - Test extraction on one real PDF manually
  </action>
  <verify>
python -c "import pdfplumber; print('pdfplumber version:', pdfplumber.__version__)"
  </verify>
  <done>
- pdfplumber in requirements.txt
- CLI test mode works
- Can extract text from at least one real PDF
  </done>
</task>

</tasks>

<verification>
After completing all tasks:
1. Run `python -m pytest tests/test_pdf_extractor.py -v` - all tests pass
2. Run `python src/data/pdf_extractor.py <path-to-real-pdf>` - extracts text successfully
3. Verify Chinese characters are preserved in output
4. Check that page markers are present
5. Verify error handling works with fake path
</verification>

<success_criteria>
- [ ] `src/data/pdf_extractor.py` exists with `extract_pdf_text()` function
- [ ] Function returns dict with success, text, pages, error keys
- [ ] pdfplumber dependency in requirements.txt
- [ ] Unit tests pass (≥5 tests)
- [ ] Can extract text from real Chinese PDFs
- [ ] Error handling works for missing/corrupted files
</success_criteria>

<output>
After completion, create `.planning/phases/02-pdf-processing/02-01-SUMMARY.md`
</output>
