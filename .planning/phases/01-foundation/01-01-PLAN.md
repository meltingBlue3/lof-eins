---
phase: 01-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/data/loader.py
  - src/data/downloader.py
autonomous: true

must_haves:
  truths:
    - "DataLoader correctly handles NULL/NaT end_date for open-ended limits"
    - "Events with end_date=NULL apply to all dates >= start_date"
    - "downloader.py CREATE TABLE allows NULL end_date"
    - "generators.py already supports NULL end_date (verified)"
  artifacts:
    - path: "src/data/loader.py"
      provides: "Fixed _resample_limits_to_daily() with NULL handling"
      pattern: "pd.isna\(end\)"
    - path: "src/data/downloader.py"
      provides: "Schema with nullable end_date"
      pattern: "end_date DATE,?"  # No NOT NULL
  key_links:
    - from: "loader.py line 224"
      to: "NULL end_date handling"
      pattern: "if pd.isna\(end\)"
---

<objective>
Fix critical bugs related to NULL end_date handling for open-ended limits.

Purpose: Open-ended limits (where end_date is unknown/unset) are a core requirement for the LOF purchase limit system. The current DataLoader code fails to correctly apply these limits because the comparison `date_index <= end` is never True when `end` is NaT/NULL.

Output: Bug-free DataLoader that correctly applies open-ended limits, with consistent database schema across all modules.
</objective>

<execution_context>
@C:/Users/zhang/.config/opencode/get-shit-done/workflows/execute-plan.md
@C:/Users/zhang/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Current Bug in loader.py (line 224):**
```python
mask = (date_index >= start) & (date_index <= end)
```
When `end` is NULL/NaT (pandas NaN-like for dates), `date_index <= end` returns all False, so open-ended limits never apply.

**Schema inconsistency:**
- downloader.py: `end_date DATE NOT NULL` (line 276)
- generators.py: `end_date DATE` (nullable, line 211) - already correct

**Fix approach:**
For open-ended limits (end is NaT), mask should be `date_index >= start` only.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix NULL end_date handling in DataLoader</name>
  <files>src/data/loader.py</files>
  <action>
    Modify the `_resample_limits_to_daily()` method to correctly handle NULL/NaT end_date values.
    
    Current code (lines 217-225):
    ```python
    for _, event in df_limits.iterrows():
        start = event['start_date']
        end = event['end_date']
        max_amount = event['max_amount']
        
        # Create mask for dates within this limit period
        mask = (date_index >= start) & (date_index <= end)
        daily_limits.loc[mask] = max_amount
    ```
    
    Update to:
    ```python
    for _, event in df_limits.iterrows():
        start = event['start_date']
        end = event['end_date']
        max_amount = event['max_amount']
        
        # Create mask for dates within this limit period
        # Handle open-ended limits (NULL/NaT end_date)
        if pd.isna(end):
            mask = date_index >= start
        else:
            mask = (date_index >= start) & (date_index <= end)
        daily_limits.loc[mask] = max_amount
    ```
    
    This ensures that when end_date is NULL, the limit applies to all dates from start_date onwards.
  </action>
  <verify>
    Run a quick test: `python -c "import pandas as pd; print(pd.isna(pd.NaT))"` should output True
  </verify>
  <done>
    - `_resample_limits_to_daily()` contains NULL handling logic using `pd.isna(end)`
    - Open-ended limits (end=NULL) will apply to all dates >= start_date
  </done>
</task>

<task type="auto">
  <name>Task 2: Update downloader.py schema to allow NULL end_date</name>
  <files>src/data/downloader.py</files>
  <action>
    Update the `_generate_limit_db()` method to make end_date nullable, consistent with generators.py.
    
    Current schema (lines 271-280):
    ```python
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS limit_events (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            ticker TEXT NOT NULL,
            start_date DATE NOT NULL,
            end_date DATE NOT NULL,
            max_amount REAL NOT NULL,
            reason TEXT
        )
    ''')
    ```
    
    Update to:
    ```python
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS limit_events (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            ticker TEXT NOT NULL,
            start_date DATE NOT NULL,
            end_date DATE,
            max_amount REAL NOT NULL,
            reason TEXT
        )
    ''')
    ```
    
    Remove the NOT NULL constraint from end_date to allow NULL values for open-ended limits.
  </action>
  <verify>
    Search for "end_date DATE" in the file to confirm the change was made
  </verify>
  <done>
    - end_date column in CREATE TABLE has no NOT NULL constraint
    - Schema is now consistent between downloader.py and generators.py
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify generators.py schema compatibility</name>
  <files>src/data/generator/generators.py</files>
  <action>
    Verify that generators.py already has the correct nullable schema for end_date.
    
    The schema at lines 206-215 should already be:
    ```python
    cursor.execute("""
        CREATE TABLE IF NOT EXISTS limit_events (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            ticker TEXT NOT NULL,
            start_date DATE NOT NULL,
            end_date DATE,
            max_amount REAL DEFAULT 100.0,
            reason TEXT
        )
    """)
    ```
    
    This already has `end_date DATE` without NOT NULL, which is correct.
    
    Also verify that the INSERT statement (lines 218-228) handles NULL correctly by passing the event values directly.
    
    Document this verification in a comment near the schema for future reference:
    ```python
    # Note: end_date is nullable to support open-ended limits
    ```
  </action>
  <verify>
    Confirm end_date schema in generators.py does NOT have NOT NULL constraint
  </verify>
  <done>
    - Verified generators.py already supports NULL end_date
    - Added comment documenting nullable end_date for open-ended limits
  </done>
</task>

</tasks>

<verification>
After completing all tasks:
1. Create a quick verification script to test NULL handling
2. Run existing tests to ensure no regressions
3. Verify schema consistency across all three files
</verification>

<success_criteria>
- DataLoader._resample_limits_to_daily() correctly applies limits with NULL end_date
- downloader.py CREATE TABLE allows NULL end_date
- All schema definitions are consistent (nullable end_date)
- No regressions in existing functionality
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-01-SUMMARY.md`
</output>
