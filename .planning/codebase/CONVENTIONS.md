# Coding Conventions

**Analysis Date:** 2025-02-06

## Naming Patterns

**Files:**
- **Modules:** `snake_case.py` - e.g., `simple_lof.py`, `announcement_downloader.py`
- **Classes:** `PascalCase` - e.g., `DataLoader`, `BacktestEngine`, `SimpleLOFStrategy`
- **Methods:** `snake_case` - e.g., `generate_signals`, `calculate_subscription_fee`
- **Variables:** `snake_case` - e.g., `premium_rate`, `daily_limit`, `max_amount`
- **Private:** Prefix with underscore for internal use - e.g., `_fees_cache`, `_current_date`

**Constants:**
- **Module-level:** `UPPER_SNAKE_CASE` - e.g., `DEFAULT_FEES`, `DEFAULT_CONFIG_PATH`
- **Class-level:** `UPPER_SNAKE_CASE` - e.g., `DataLoader.DEFAULT_FEES`

**Type Hints:**
- Mandatory for all function signatures
- Use `typing` imports: `Optional`, `Dict`, `List`, `Union`, `Literal`
- Return type `None` explicitly for void functions
- Use `->` syntax consistently

## Code Style

**Docstrings:**
- **Style:** Google/NumPy docstring format
- **Location:** Triple-quoted docstring at module, class, and method level
- **Structure:** Brief summary, detailed description, Args, Returns, Raises sections

```python
def load_bundle(
    self,
    ticker: str,
    start_date: Optional[str] = None,
    end_date: Optional[str] = None
) -> pd.DataFrame:
    """Load and merge all data for a single ticker.
    
    Args:
        ticker: Fund ticker symbol (e.g., '161005').
        start_date: Optional start date filter (format: 'YYYY-MM-DD').
        end_date: Optional end date filter (format: 'YYYY-MM-DD').
        
    Returns:
        DataFrame indexed by date with columns: open, high, low, close, volume, nav, premium_rate, daily_limit
        
    Raises:
        FileNotFoundError: If market or NAV data files don't exist.
    """
```

**Formatting:**
- **Tool:** Not explicitly configured (no .pylintrc, setup.cfg, or pyproject.toml found)
- **Indentation:** 4 spaces
- **Line length:** Appears to follow ~100 character limit
- **Imports:** Standard library first, third-party second, local imports last

## Import Organization

**Order:**
1. **Standard library** - `import sys`, `import sqlite3`, `from pathlib import Path`
2. **Third-party** - `import pandas as pd`, `import numpy as np`, `import yaml`
3. **Local modules** - `from src.config import BacktestConfig`

**Pattern:**
```python
# Standard library
import logging
from dataclasses import dataclass
from datetime import date

# Third-party
import numpy as np
import pandas as pd

# Local imports
from src.config import BacktestConfig
from src.data.loader import DataLoader
```

**Path Aliases:**
- `pandas` → `pd`
- `numpy` → `np`

## Error Handling

**Patterns:**
- **Validation:** Use `__post_init__` in dataclasses for parameter validation
- **Exceptions:** Raise specific exceptions (`FileNotFoundError`, `ValueError`)
- **Graceful degradation:** Log warnings and return empty/defaults on recoverable errors

```python
def __post_init__(self) -> None:
    """Validate configuration parameters."""
    if self.initial_cash <= 0:
        raise ValueError(f"initial_cash must be positive, got {self.initial_cash}")
```

**Error Messages:**
- Use descriptive messages with actual values
- Use f-strings for formatting

## Logging

**Framework:** Python standard `logging` module

**Patterns:**
- Get logger per module: `logger = logging.getLogger(__name__)`
- Levels: `INFO` for operations, `DEBUG` for detailed flow, `WARNING` for recoverable issues
- Format: `%(asctime)s - %(levelname)s - %(message)s`

```python
logger.info(
    "SELL %s: %.2f shares @ %.4f = %.2f (comm: %.2f)",
    ticker, shares, price, net_proceeds, commission
)
```

## Type Hints

**Conventions:**
- All public methods have complete type annotations
- Use `Optional[X]` for nullable types
- Use `Union[X, Y]` (or `X | Y` in Python 3.10+) for multiple types
- Use `Literal` for string literals: `Literal['fixed', 'infinite']`
- Use `...` for overload signatures (if needed)

```python
def resolve_tickers(
    tickers_config: Union[str, List[str], None],
    data_loader: DataLoader
) -> List[str]:
    ...
```

## Dataclasses

**Pattern:** Use `@dataclass` for configuration and data containers

```python
@dataclass
class Signal:
    """Trading signal generated by a strategy."""
    
    action: Literal['buy', 'sell']
    ticker: str
    amount: float
```

**Validation:**
- Implement `__post_init__` for parameter validation
- Use `field(default_factory=list)` for mutable defaults
- Use `field(default=..., repr=False)` for internal fields

## Function Design

**Size:** Functions are typically 10-50 lines, focused on single responsibility

**Parameters:**
- Use named parameters for clarity
- Provide default values for optional parameters
- Use `float('inf')` as sentinel for "unlimited" or "maximum"

**Return Values:**
- Return typed objects (DataFrames, dataclasses, dicts)
- Return `Optional[Type]` when operation may fail silently
- Return `None` for void operations that may fail

## Module Design

**Exports:**
- Use `__all__` in package `__init__.py` files to define public API
- Conditional imports handled with try/except and `_MODULE_AVAILABLE` flags

```python
# src/data/__init__.py
try:
    from .downloader import RealDataDownloader, download_all_lof
    _DOWNLOADER_AVAILABLE = True
except ImportError:
    _DOWNLOADER_AVAILABLE = False
    RealDataDownloader = None
    download_all_lof = None

__all__ = ["DataLoader", "MockConfig", "generate_mock_data"]
```

**Barrel Files:**
- Each package exposes key classes through `__init__.py`
- Avoid circular imports through careful ordering

## Configuration Files

**Format:** YAML for configuration files

**Naming:**
- Module configs: `configs/backtest.yaml`, `configs/mock.yaml`
- Example configs: `.env.example`

---

*Convention analysis: 2025-02-06*
